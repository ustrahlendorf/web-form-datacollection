# Quick Start: Environment Configuration

## Recommended: deploy infrastructure via Taskfile (repo root)

From the repo root (`AWS-kiro/`), you can deploy the infra stacks with Taskfile guardrails:

```bash
task doctor

# one-time: creates static SSM parameters under /HeatingDataCollection
task deploy-init

# deploy/update DynamoDB pointers and API wiring
task deploy-dynamodb
task deploy-api
task deploy-frontend
```

Notes:
- The Taskfile loads `taskfile.env` automatically (including `SSM_NAMESPACE_PREFIX=/HeatingDataCollection`).
- Frontend asset upload is still performed from `web-form-verbrauch/frontend/` (see below).

## One-Command Deployment

Deploy the entire application with a single command:

```bash
# From the project root
cd infrastructure/
bash deploy-with-config.sh dev

# Then setup and deploy frontend
cd ../frontend/
bash setup-env.sh dev
bash build.sh
bash deploy.sh dev
```

## What Gets Configured

### Lambda Functions
- ✅ `SUBMISSIONS_TABLE` environment variable set automatically

### Frontend
- ✅ API endpoint URL
- ✅ Cognito domain and credentials
- ✅ CloudFront domain
- ✅ Environment name

### API Gateway
- ✅ CORS policy with CloudFront domain
- ✅ JWT authorization with Cognito

### Cognito
- ✅ OAuth callback URLs with CloudFront domain
- ✅ Logout URLs with CloudFront domain

## Configuration Files

### `.env` (Frontend)
Auto-generated by `setup-env.sh`:
```bash
API_ENDPOINT=https://xxxxx.execute-api.eu-central-1.amazonaws.com
COGNITO_DOMAIN=https://data-collection-dev.auth.eu-central-1.amazoncognito.com
COGNITO_CLIENT_ID=xxxxxxxxxxxxxxxxxxxxx
COGNITO_USER_POOL_ID=eu-central-1_xxxxxxxxxxxxx
COGNITO_REDIRECT_URI=https://d111111abcdef8.cloudfront.net
CLOUDFRONT_DOMAIN=d111111abcdef8.cloudfront.net
ENVIRONMENT=dev
```

### `config.js` (Frontend)
Auto-generated by `build.sh`:
```javascript
window.APP_CONFIG = {
    API_ENDPOINT: 'https://xxxxx.execute-api.eu-central-1.amazonaws.com',
    COGNITO_DOMAIN: 'https://data-collection-dev.auth.eu-central-1.amazoncognito.com',
    COGNITO_CLIENT_ID: 'xxxxxxxxxxxxxxxxxxxxx',
    COGNITO_USER_POOL_ID: 'eu-central-1_xxxxxxxxxxxxx',
    COGNITO_REDIRECT_URI: 'https://d111111abcdef8.cloudfront.net',
    CLOUDFRONT_DOMAIN: 'd111111abcdef8.cloudfront.net',
    ENVIRONMENT: 'dev',
};
```

## Troubleshooting

| Issue | Solution |
|-------|----------|
| "Could not retrieve CloudFront domain" | Run `bash infrastructure/deploy-with-config.sh dev` first |
| "Could not retrieve API endpoint" | Verify API stack deployed: `aws cloudformation describe-stacks --stack-name DataCollectionAPI-dev` |
| "Could not retrieve Cognito configuration" | Verify Cognito stack deployed: `aws cloudformation describe-stacks --stack-name DataCollectionCognito-dev` |
| CORS errors in browser | Verify CloudFront domain is in API CORS policy |
| Cognito login fails | Verify CloudFront domain is in Cognito callback URLs |

## Environment Variables Reference

### Lambda
```
SUBMISSIONS_TABLE=submissions-dev
```

### Frontend (.env)
```
API_ENDPOINT=<API Gateway endpoint>
COGNITO_DOMAIN=<Cognito Hosted UI domain>
COGNITO_CLIENT_ID=<Cognito Client ID>
COGNITO_USER_POOL_ID=<Cognito User Pool ID>
COGNITO_REDIRECT_URI=<CloudFront domain>
CLOUDFRONT_DOMAIN=<CloudFront domain>
ENVIRONMENT=dev
```

## Scripts

### `infrastructure/deploy-with-config.sh`
Deploys CDK stacks and updates Cognito with CloudFront domain

### `frontend/setup-env.sh`
Retrieves configuration from CDK outputs and generates `.env` file

### `frontend/build.sh`
Builds frontend and generates `config.js` from `.env` file

### `frontend/deploy.sh`
Deploys frontend to S3 and invalidates CloudFront cache

## Next Steps

1. Deploy infrastructure: `bash infrastructure/deploy-with-config.sh dev`
2. Setup frontend: `bash frontend/setup-env.sh dev`
3. Build frontend: `bash frontend/build.sh`
4. Deploy frontend: `bash frontend/deploy.sh dev`
5. Open CloudFront URL in browser

## Documentation

- **Full Guide**: See `ENVIRONMENT_CONFIGURATION.md`
- **Implementation Details**: See `ENVIRONMENT_CONFIGURATION_SUMMARY.md`
- **Deployment Guide**: See `frontend/DEPLOYMENT.md`
